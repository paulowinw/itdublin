{"version":3,"file":"ajax-progress.js","sourceRoot":"","sources":["../../../../../src/components/core/player/functions/ajax-progress.ts"],"names":[],"mappings":"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","sourcesContent":["const namespace = 'presto-player.progress';\nlet visit_time = Date.now();\nlet nonce;\n\n/**\n * Sends an updated ajax progress event for plugins to hook into\n */\nexport default player => {\n  // automations are disabled\n  if (!player.automations) {\n    return;\n  }\n\n  // set nonce when fetched\n  if (!window?.wp?.hooks?.hasAction('presto.nonceRefreshed', namespace)) {\n    window.wp.hooks.addAction('presto.nonceRefreshed', namespace, newNonce => {\n      nonce = newNonce;\n    });\n  }\n\n  // on time update, maybe send time update\n  window?.wp.hooks.addAction('presto.playerTimeUpdate', 'presto-player', sendTimeUpdate);\n  // be sure to mark complete on end\n  window?.wp.hooks.addAction('presto.playerEnded', 'presto-player', plyr => sendTimeUpdate(plyr, 100));\n\n  let watched = {\n    0: false,\n    10: false,\n    20: false,\n    30: false,\n    40: false,\n    50: false,\n    60: false,\n    70: false,\n    80: false,\n    90: false,\n    100: false,\n  };\n\n  function sendTimeUpdate(player, percent = null) {\n    // need to send nonce\n    if (!nonce) {\n      return;\n    }\n\n    // bail if progress is not turned on\n    if (!player?.config?.ajaxProgress) {\n      return;\n    }\n\n    if (!percent) {\n      percent = (parseFloat(player.currentTime) / parseFloat(player.duration)) * 100;\n    }\n\n    player.watched = player.watched || {};\n    Object.keys(watched).forEach(m => {\n      const marker = parseInt(m);\n      if (!player.watched[marker] && percent >= marker) {\n        player.watched[marker] = true;\n\n        let formData = new FormData();\n\n        formData.append('action', 'presto_player_progress_percent');\n        formData.append('id', player?.config?.id);\n        formData.append('percent', marker.toString());\n        formData.append('visit_time', visit_time.toString());\n        formData.append('nonce', nonce);\n\n        if (window?.prestoPlayer?.debug) {\n          console.log(`${marker} percent watched.`);\n        }\n\n        if (!window?.prestoPlayer?.debug_navigator) {\n          let result = navigator.sendBeacon(window?.prestoPlayer?.ajaxurl, formData);\n          if (window?.prestoPlayer?.debug) {\n            if (result) {\n              console.log('Successfully queued progress:', {\n                id: player?.config?.id,\n                percent: marker,\n                visit_time,\n                nonce,\n              });\n            } else {\n              console.log('Failed to queue progress', {\n                id: player?.config?.id,\n                percent: marker,\n                visit_time,\n                nonce,\n              });\n            }\n          }\n        } else {\n          window.jQuery.ajax({\n            type: 'POST',\n            url: window?.prestoPlayer?.ajaxurl,\n            dataType: 'json',\n            cache: false,\n            data: {\n              action: 'presto_player_progress_percent',\n              id: player?.config?.id,\n              visit_time,\n              percent: marker,\n              nonce,\n            },\n          });\n        }\n      }\n    });\n  }\n};\n"]}