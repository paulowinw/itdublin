{"version":3,"file":"search-vtt.js","sourceRoot":"","sources":["../../../../../src/components/core/player/functions/search-vtt.ts"],"names":[],"mappings":"AAAA,OAAO,IAAI,MAAM,SAAS,CAAC;AAC3B,OAAO,EAAE,aAAa,EAAE,MAAM,QAAQ,CAAC;AACvC,OAAO,EAAE,OAAO,EAAE,MAAM,cAAc,CAAC;AACvC,OAAO,EAAE,MAAM,MAAM,CAAC;AAEtB;;;;GAIG;AACH,MAAM,CAAC,MAAM,SAAS,GAAG,KAAK,CAAC,EAAE;IAC/B,IAAI,CAAC,KAAK;QAAE,OAAO,IAAI,CAAC;IAExB,MAAM,GAAG,GAAG,CAAC,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,IAAI,EAAE,iCAAiC,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC,MAAM,CACtG,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE;QACZ,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC;YAChB,GAAG,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC;QAC1B,CAAC;QACD,OAAO,GAAG,CAAC;IACb,CAAC,EACD;QACE,IAAI,EACF,KAAK,CAAC,IAAI;YACV,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,UAAU,GAAG;gBAChD,OAAO;oBACL,SAAS,EAAE,GAAG,CAAC,SAAS;oBACxB,OAAO,EAAE,GAAG,CAAC,OAAO;oBACpB,IAAI,EAAE,GAAG,CAAC,IAAI;oBACd,EAAE,EAAE,GAAG,CAAC,EAAE;iBACX,CAAC;YACJ,CAAC,CAAC;KACL,CACF,CAAC;IAEF,OAAO,GAAG,CAAC;AACb,CAAC,CAAC;AAEF;;;;;GAKG;AACH,MAAM,WAAW,GAAG,CAAC,aAAa,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;IAClD,IAAI,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC;QAAE,OAAO,EAAE,CAAC;IAC9B,IAAI,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC;QAAE,OAAO,EAAE,CAAC;IAChC,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,aAAa,CAAC;QAAE,OAAO,EAAE,CAAC;IAEzC;;;;;;;;;;;;;;;;;;OAkBG;IACH,MAAM,OAAO,iDACR,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,kBAAkB,GAC1B,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,SAAS,KACpB,UAAU,EAAE,KAAK,EACjB,cAAc,EAAE,IAAI,EACpB,SAAS,EAAE,GAAG,EACd,IAAI,EAAE,CAAC,MAAM,CAAC,GACf,CAAC;IAEF,IAAI,IAAI,KAAK,IAAI,IAAI,CAAC,IAAI,IAAI,CAAC,KAAK,IAAI,CAAC,MAAM,EAAE,CAAC;QAChD,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,MAAM,UAAU,GAAG,IAAI,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;IAC3C,OAAO,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC;AAC1C,CAAC,CAAC;AAEF;;;;;GAKG;AACH,MAAM,YAAY,GAAG,CAAC,YAAY,EAAE,IAAI,EAAE,MAAM,EAAE,EAAE;IAClD,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,YAAY,CAAC;QAAE,OAAO,EAAE,CAAC;IACxC,IAAI,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC;QAAE,OAAO,EAAE,CAAC;IAC9B,IAAI,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC;QAAE,OAAO,EAAE,CAAC;IAEhC,MAAM,YAAY,GAAG,WAAW,CAAC,YAAY,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;IAE7D,OAAO,CACL,YAAY;QACZ,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,YAAY,EAAE,UAAU,MAAM;YACrD,OAAO;gBACL,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC;gBACtC,KAAK,EAAE,EAAE;aACV,CAAC;QACJ,CAAC,CAAC,CACH,CAAC;AACJ,CAAC,CAAC;AAEF;;;;;GAKG;AACH,MAAM,UAAU,SAAS,CAAC,MAAM,EAAE,YAAY;;IAC5C,IAAI,CAAC,MAAM;QAAE,OAAO;IACpB,IAAI,CAAC,CAAA,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,KAAK,0CAAE,UAAU,CAAA,IAAI,CAAA,MAAA,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,KAAK,0CAAE,UAAU,0CAAE,MAAM,MAAK,CAAC;QAAE,OAAO;IAElF,MAAM,KAAK,GAAG,MAAM,CAAC,KAAK,CAAC,UAAU,CAAC;IACtC,MAAM,MAAM,GAAG,CAAA,MAAA,MAAM,CAAC,MAAM,CAAC,MAAM,0CAAE,MAAM,KAAI,EAAE,CAAC;IAElD,IAAI,IAAI,GAAG,EAAE,CAAC;IACd,IAAI,MAAM,CAAC,QAAQ,CAAC,YAAY,KAAK,CAAC,CAAC,EAAE,CAAC;QACxC,oEAAoE;QACpE,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;IACzB,CAAC;SAAM,CAAC;QACN,IAAI,GAAG,KAAK,CAAC,MAAM,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC;IAC7C,CAAC;IAED,IAAI,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC;QAAE,OAAO,EAAE,CAAC;IAE9B,MAAM,SAAS,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;IAElC,IAAI,EAAE,CAAC,KAAK,CAAC,SAAS,CAAC;QAAE,OAAO,EAAE,CAAC;IAEnC,OAAO,YAAY,CAAC,YAAY,EAAE,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,IAAI,EAAE,MAAM,CAAC,CAAC;AAC7D,CAAC;AAED,MAAM,UAAU,gBAAgB,CAAC,MAAM;;IACrC,IAAI,CAAC,MAAM;QAAE,OAAO;IACpB,IAAI,CAAC,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,QAAQ,CAAA,IAAI,CAAC,CAAA,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,QAAQ,0CAAE,QAAQ,CAAA;QAAE,OAAO;IAE7D,sBAAsB;IACtB,IAAI,UAAU,GAAG,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,gBAAgB,CAAC,yBAAyB,CAAC,CAAC;IACtF,IAAI,EAAE,CAAC,KAAK,CAAC,UAAU,CAAC;QAAE,OAAO;IACjC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;QAC3C,UAAU,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC;IACzB,CAAC;AACH,CAAC;AAED,MAAM,UAAU,UAAU,CAAC,MAAM,EAAE,MAAM;IACvC,IAAI,CAAC,MAAM;QAAE,OAAO;IAEpB,gBAAgB,CAAC,MAAM,CAAC,CAAC;IAEzB,IAAI,CAAC,CAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,MAAM,CAAA;QAAE,OAAO;IAE5B,MAAM,iBAAiB,GAAG,QAAQ,CAAC,sBAAsB,EAAE,CAAC;IAC5D,MAAM,cAAc,GAAG,QAAQ,CAAC,sBAAsB,EAAE,CAAC;IAEzD,uCAAuC;IACvC,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;QACrB,MAAM,aAAa,GAAG,aAAa,CACjC,MAAM,EACN;YACE,KAAK,EAAE,wBAAwB;SAChC,EACD,EAAE,CACH,CAAC;QAEF,MAAM,IAAI,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,GAAG,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,GAAG,CAAC;QAExD,aAAa,CAAC,gBAAgB,CAAC,OAAO,EAAE,GAAG,EAAE;YAC3C,MAAM,CAAC,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC;QAClC,CAAC,CAAC,CAAC;QAEH,aAAa,CAAC,KAAK,CAAC,IAAI,GAAG,IAAI,CAAC;QAChC,cAAc,CAAC,WAAW,CAAC,aAAa,CAAC,CAAC;IAC5C,CAAC,CAAC,CAAC;IAEH,iBAAiB,CAAC,WAAW,CAAC,cAAc,CAAC,CAAC;IAE9C,MAAM,CAAC,QAAQ,CAAC,OAAO,GAAG;QACxB,MAAM,EAAE,cAAc;QACtB,GAAG,EAAE,IAAI;KACV,CAAC;IAEF,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,WAAW,CAAC,iBAAiB,CAAC,CAAC;AAC1D,CAAC","sourcesContent":["import Fuse from 'fuse.js';\nimport { createElement } from './util';\nimport { getCues } from './cache-cues';\nimport is from './is';\n\n/**\n *\n * @param {TextTrack} track\n * @returns Cues fron the track\n */\nexport const vttToJson = track => {\n  if (!track) return null;\n\n  const ret = ['kind', 'label', 'language', 'id', 'inBandMetadataTrackDispatchType', 'mode', 'src'].reduce(\n    (acc, prop) => {\n      if (track[prop]) {\n        acc[prop] = track[prop];\n      }\n      return acc;\n    },\n    {\n      cues:\n        track.cues &&\n        Array.prototype.map.call(track.cues, function (cue) {\n          return {\n            startTime: cue.startTime,\n            endTime: cue.endTime,\n            text: cue.text,\n            id: cue.id,\n          };\n        }),\n    },\n  );\n\n  return ret;\n};\n\n/**\n *\n * @param {String} searchKeyword\n * @param {JSON} list\n * @returns Object of search results\n */\nconst fuzzySearch = (searchKeyword, list, preset) => {\n  if (is.empty(list)) return [];\n  if (is.empty(preset)) return [];\n  if (!is.string(searchKeyword)) return [];\n\n  /**\n   * Default settings for the Fusejs library.\n   * Reference - https://fusejs.io/api/options.html\n   *\n   * isCaseSensitive: false\n   * includeScore: true\n   * shouldSort: true\n   * includeMatches: true\n   * findAllMatches: false\n   * minMatchCharLength: 1\n   * location: 0\n   * threshold: 0.3\n   * distance: 100\n   * useExtendedSearch: false\n   * ignoreLocation: false\n   * ignoreFieldNorm: false\n   * fieldNormWeight: 1\n   *\n   */\n  const options = {\n    ...preset?.minMatchCharLength,\n    ...preset?.threshold,\n    shouldSort: false,\n    includeMatches: true,\n    threshold: 0.3,\n    keys: ['text'],\n  };\n\n  if (null === list || !list || 0 === list.length) {\n    return [];\n  }\n\n  const fuseObject = new Fuse(list, options);\n  return fuseObject.search(searchKeyword);\n};\n\n/**\n *\n * @param {String} searchString\n * @param {JSON} list\n * @returns Array of time in seconds where the search string is found.\n */\nconst searchInJson = (searchString, list, preset) => {\n  if (!is.string(searchString)) return [];\n  if (is.empty(list)) return [];\n  if (is.empty(preset)) return [];\n\n  const searchResult = fuzzySearch(searchString, list, preset);\n\n  return (\n    searchResult &&\n    Array.prototype.map.call(searchResult, function (result) {\n      return {\n        time: Math.ceil(result.item.startTime),\n        label: ''\n      };\n    })\n  );\n};\n\n/**\n *\n * @param {any} player\n * @param {string} searchString\n * @returns Array of time in seconds where the search string is found.\n */\nexport function searchVtt(player, searchString) {\n  if (!player) return;\n  if (!player?.media?.textTracks || player?.media?.textTracks?.length === 0) return;\n\n  const track = player.media.textTracks;\n  const preset = player.config.preset?.search || '';\n\n  let cues = '';\n  if (player.captions.currentTrack === -1) {\n    // When no track is selected, grab the cues from cache localstorage.\n    cues = getCues(player);\n  } else {\n    cues = track[player.captions.currentTrack];\n  }\n\n  if (is.empty(cues)) return [];\n\n  const jsonTrack = vttToJson(cues);\n\n  if (is.empty(jsonTrack)) return [];\n\n  return searchInJson(searchString, jsonTrack?.cues, preset);\n}\n\nexport function removeOldMarkers(player) {\n  if (!player) return;\n  if (!player?.elements || !player?.elements?.progress) return;\n\n  // Remove old markers.\n  let oldMarkers = player.elements.progress.querySelectorAll('.plyr__progress__marker');\n  if (is.empty(oldMarkers)) return;\n  for (var i = 0; i < oldMarkers.length; i++) {\n    oldMarkers[i].remove();\n  }\n}\n\nexport function setMarkers(player, points) {\n  if (!player) return;\n\n  removeOldMarkers(player);\n\n  if (!points?.length) return;\n\n  const containerFragment = document.createDocumentFragment();\n  const pointsFragment = document.createDocumentFragment();\n\n  // Inject markers to progress container\n  points.forEach(point => {\n    const markerElement = createElement(\n      'span',\n      {\n        class: 'plyr__progress__marker',\n      },\n      '',\n    );\n\n    const left = `${(point.time / player.duration) * 100}%`;\n\n    markerElement.addEventListener('click', () => {\n      player.currentTime = point.time;\n    });\n\n    markerElement.style.left = left;\n    pointsFragment.appendChild(markerElement);\n  });\n\n  containerFragment.appendChild(pointsFragment);\n\n  player.elements.markers = {\n    points: pointsFragment,\n    tip: null,\n  };\n\n  player.elements.progress.appendChild(containerFragment);\n}\n"]}