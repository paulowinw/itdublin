{"version":3,"file":"get-nonce.js","sourceRoot":"","sources":["../../../../../src/components/core/player/functions/get-nonce.ts"],"names":[],"mappings":"AAAA,IAAI,QAAQ,GAAG,KAAK,CAAC;AACrB,IAAI,OAAO,GAAG,KAAK,CAAC;AAEpB,SAAS,MAAM,CAAC,QAAQ;IACtB,IAAI,QAAQ,CAAC,MAAM,IAAI,GAAG,IAAI,QAAQ,CAAC,MAAM,GAAG,GAAG,EAAE,CAAC;QACpD,OAAO,OAAO,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;IACnC,CAAC;SAAM,CAAC;QACN,OAAO,OAAO,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC;IACxD,CAAC;AACH,CAAC;AAED,eAAe,MAAM,CAAC,EAAE;;IACtB,+BAA+B;IAC/B,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC;QAC3D,OAAO;IACT,CAAC;IAED,MAAA,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,EAAE,0CAAE,KAAK,0CAAE,SAAS,CAAC,sBAAsB,EAAE,eAAe,EAAE,GAAG,EAAE;QACzE,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,EAAE,CAAC,KAAK,CAAC,QAAQ,CAAC,uBAAuB,CAAC,CAAC;IACrD,CAAC,CAAC,CAAC;IAEH,oBAAoB;IACpB,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,EAAE,CAAC,KAAK,CAAC,SAAS,CAAC,uBAAuB,EAAE,eAAe,EAAE,GAAG,EAAE;;QACxE,8CAA8C;QAC9C,IAAI,QAAQ,IAAI,OAAO,EAAE,CAAC;YACxB,OAAO;QACT,CAAC;QAED,iBAAiB;QACjB,OAAO,GAAG,IAAI,CAAC;QAEf,WAAW;QACX,KAAK,CAAC,GAAG,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,YAAY,0CAAE,OAAO,uCAAuC,CAAC;aAC3E,IAAI,CAAC,MAAM,CAAC;aACZ,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;aACjC,IAAI,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE,EAAE;YACjB,MAAM,KAAK,GAAG,IAAI,CAAC;YACnB,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,EAAE,CAAC,KAAK,CAAC,QAAQ,CAAC,uBAAuB,EAAE,KAAK,CAAC,CAAC;YAC1D,YAAY;YACZ,QAAQ,GAAG,IAAI,CAAC;QAClB,CAAC,CAAC;aACD,KAAK,CAAC,UAAU,KAAK;YACpB,OAAO,CAAC,GAAG,CAAC,gBAAgB,EAAE,KAAK,CAAC,CAAC;QACvC,CAAC,CAAC;aACD,OAAO,CAAC,GAAG,EAAE;YACZ,sBAAsB;YACtB,OAAO,GAAG,KAAK,CAAC;QAClB,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;AACL,CAAC,CAAC","sourcesContent":["let fetching = false;\nlet fetched = false;\n\nfunction status(response) {\n  if (response.status >= 200 && response.status < 300) {\n    return Promise.resolve(response);\n  } else {\n    return Promise.reject(new Error(response.statusText));\n  }\n}\n\nexport default player => {\n  // we don't have need for nonce\n  if (!player.config.analytics && !player.config.automations) {\n    return;\n  }\n\n  window?.wp?.hooks?.addAction('presto.playerPlaying', 'presto-player', () => {\n    window?.wp.hooks.doAction('presto.playerGetNonce');\n  });\n\n  // get nonce refresh\n  window?.wp.hooks.addAction('presto.playerGetNonce', 'presto-player', () => {\n    // bail if we are already getting it or got it\n    if (fetching || fetched) {\n      return;\n    }\n\n    // we're fetching\n    fetched = true;\n\n    // fetch it\n    fetch(`${window?.prestoPlayer?.ajaxurl}?action=presto_refresh_progress_nonce`)\n      .then(status)\n      .then(response => response.json())\n      .then(({ data }) => {\n        const nonce = data;\n        window?.wp.hooks.doAction('presto.nonceRefreshed', nonce);\n        // we got it\n        fetching = true;\n      })\n      .catch(function (error) {\n        console.log('Request failed', error);\n      })\n      .finally(() => {\n        // we're done fetching\n        fetched = false;\n      });\n  });\n};\n"]}